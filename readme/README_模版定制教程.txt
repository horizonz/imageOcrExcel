
ROI 标注工具使用说明

一、功能概述
- 支持对图片进行多区域（ROI）标注，每个区域画框后立即命名列字段。
- 保存时自动与已有配置合并，并按“列名”去重；同名字段以最新标注覆盖旧值，避免重复条目。
- 已有配置中的字段以黄色框显示，本次新增的已命名字段以绿色框显示。

二、环境要求
- Python 3.8+（建议）
- 必需：opencv-python（cv2）用于标注交互
  安装：pip install opencv-python
- 若使用批量 OCR 导出 Excel（mass_ocr_to_excel.py）：
  - pillow、pandas、pytesseract、tqdm
  安装：pip install pillow pandas pytesseract tqdm

三、运行标注工具
1. 将待标注图片放在项目的 images/ 文件夹内。
2. 终端进入项目目录：
   cd /Users/a1-6/Desktop/pythonProgject/python_imagtotext
3. 运行脚本：
   python3 roi_configurator.py
4. 脚本会打开首张图片作为模板进行标注，并显示帮助提示与已有字段。

四、标注流程
1. 使用鼠标左键拖拽进行画框，松开鼠标后立即弹出命名输入框。
2. 在左上角输入列名，按回车确认（或按 ESC 使用默认列名）。
3. 重复画多个框，每画完一个都会先命名，绿色显示列名。
4. 完成后按一次保存键（见下文快捷键）即可将所有新增字段写入配置文件。

五、快捷键说明
- 单键：
  - u 撤销最后一个新增框
  - c 清空本次新增
  - d 丢弃已有（黄色）字段，仅保留本次新增
  - s 保存配置
  - q / ESC 退出（不保存）
- 组合键（兼容）：
  - Ctrl+S 保存配置
  - Ctrl+Z 撤销最后一个新增框
  - Ctrl+D 丢弃已有（黄色）字段，仅保留本次新增
  - Ctrl+C 清空本次新增
  - Ctrl+Q 退出
- 注意：只有在“命名阶段”（左上角显示“输入：…”）输入框才接收文字；其他阶段按键用于操控，不会被当作列名。

六、保存与去重策略
- 保存时将本次新增与已有配置合并，并根据“列名”去重；同名字段以当前新增覆盖历史值。
- 若不需要合并已有字段，先按 d 键丢弃黄色字段，仅保留本次新增后再保存。

七、配置文件位置与格式
- 保存至项目根目录的 roi_config.json。
- 字段说明：
  - template_image：模板图片文件名（用于记录参考）
  - template_size：模板图片尺寸，包含 width/height（像素）
  - rois：数组，每项为一个区域对象：
    - name：列名（字符串）
    - x, y, w, h：归一化坐标与尺寸（0~1，相对于模板图宽高）
- 示例：
  {
    "template_image": "AAA_常佳俊_22233.jpg",
    "template_size": {"width": 1642, "height": 1270},
    "rois": [
      {"name": "cname", "x": 0.36, "y": 0.446, "w": 0.262, "h": 0.085},
      {"name": "number", "x": 0.256, "y": 0.8, "w": 0.137, "h": 0.031}
    ]
  }

八、与批量 OCR 集成
1. 确保已生成并保存 roi_config.json。
2. 运行批量识别并导出 Excel：
   python3 mass_ocr_to_excel.py
3. 脚本会读取 roi_config.json 并按各 ROI 列名导出对应识别结果到 ocr_result.xlsx。
4. 支持断点续跑与增量追加；已处理图片会跳过，最终Excel按 filename 去重。

九、常见问题与提示
- 画框后直接确定：这是设计的“即时命名”流程；每个框完成后先命名再继续标注，最后一次性保存。
- 保存后出现重复字段：合并时按“列名去重”，请确保不同区域使用不同列名；同名字段会覆盖旧值。
- 快捷键无效或输入框抢占：仅命名阶段接收文字；若按键无效，请点击 OpenCV 窗口使其获得焦点后再尝试。
- 列名建议：保持唯一且有意义，避免与已有配置重名。

十、变更记录（与旧版差异）
- 新增：画框结束后立即命名，每次保存只需按一次 s/Ctrl+S。
- 优化：保存时合并并按列名去重，避免 roi_config 出现多余重复项。
- 扩展：支持 Ctrl 组合快捷键，交互更稳定；帮助提示区域更新。

十一、反馈与扩展
- 如需按坐标相似度进行更严格去重（例如按重叠面积或距离阈值），请反馈判定规则，我可以进一步增强逻辑。
- 如需不同图片模板分别保存为多份配置，也可按需扩展为多个 roi_config_*.json。